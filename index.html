<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>

    <style type="text/css">
        body {
            background-color: rgb(11, 7, 56);
        }

        h1 {
            color: rgb(115, 115, 115);
            font-size: 18px;
            font-family: sans-serif;
            font-weight: bold;
            margin: 0;
            padding-bottom: 10px;

        }

        text {
            color: white;
        }

        #container {
            width: 800px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 20px;
            padding: 20px;
            background-color: rgb(11, 7, 56);
            box-shadow: 1px 1px 1px 2px rgb(217, 217, 217);
        }

        .country:hover {
            fill: rgb(17, 17, 17);
            cursor: pointer;
        }


        #arrowhead {
            fill: #e20000;
            stroke: none;
        }

        #border {
            fill: #ffffff;
            stroke: none;
        }

        #route {
            fill: #5b5e8541;
            stroke: none;
        }

        .migratoryroute {
            fill: #ff00aa00;
            stroke: #ff000036;
        }

        #deathsHolder {
            color: white
        }

        /* use.Black_Sea {
        fill: #fa2bb5;
        stroke: #fa2bb5;
    }

    use.Syrian_North_African {
        fill: #fae52b;
        stroke: none;
    }

    use.Central_African_Routes {
        fill: #2baefa;
    } */
    </style>


</head>

<body>

    <div id="yearSliderHolder" class="h-screen w-80 fixed t-0">
        <svg id="yearSlider"></svg>
    </div>
    <div id="countriesChartHolder" class="bottom-96 h-1/2 w-2/5 ml-64 fixed z-10">
        <svg id="countriesChart"></svg>
        <div class="flex text-white flex-row flex-wrap">
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #264653;"></div>
                <div class=""> Other </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #2A9D8F;"></div>
                <div class=""> Unknown </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #E9C46A;"></div>
                <div class=""> Iraq </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #F4A261;"></div>
                <div class=""> Somalia </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #4daf4a;"></div>
                <div class=""> Afghanistan </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #E76F51;"></div>
                <div class=""> Nigeria </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #e41a1c;"></div>
                <div class=""> Pakistan </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #377eb8;"></div>
                <div class=""> Syrian Arab Rep. </div>
            </div>
            <div class="flex">
                <div class="w-3 h-3 m-2" style="background-color: #B5E2FA;"></div>
                <div class=""> Eritrea</div>
            </div>

        </div>
    </div>


    <div id="mapHolder" class="h-full w-4/5 absolute right-0 z-0">
        <svg id="main"></svg>
    </div>

    <div id="deathsHolder" class="h-20 w-2/5 ml-64 bottom-40 fixed">
        <p class="p-3 ">
            <svg xmlns="http://www.w3.org/2000/svg" class="inline icon icon-tabler icon-tabler-cross" width="20"
                height="20" viewBox="0 0 24 24" stroke-width="1.5" stroke="#000000" fill="none" stroke-linecap="round"
                stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path stroke="white" d="M10 21h4v-9h5v-4h-5v-5h-4v5h-5v4h5z" />
            </svg> = <span id="deathCountSize"></span>
        </p>
        <svg id="deathsChart"></svg>
    </div>

    <script>

        window.addEventListener('wheel', this.handleScroll, false);

        var currentDate = moment("2009");


        // YEAR SLIDER ******** 
        var yearSliderParent = document.getElementById("yearSliderHolder");

        // Select the svg area
        var svg = d3.select("#yearSlider");

        // General settings
        const barX = 20;
        const barW = 2;
        const barHeight = yearSliderParent.clientHeight;
        const textSize = 20;

        const textOffset = 25;


        // Year on timeline settings 
        const circleR = 6;

        //Setup draw area
        svg
            .attr("width", yearSliderParent.clientWidth)
            .attr("height", yearSliderParent.clientHeight)

        // line
        var line = svg.append('rect')
            .attr('x', barX)
            .attr('y', 0)
            .attr('width', barW)
            .attr('height', barHeight)
            .attr('fill', 'white');

        var startDate = moment(currentDate);

        // We render inital 12 months
        for (var i = 1; i <= 13; i++) {
            var year_circle = svg.append("circle")
                .style("stroke", "gray")
                .style("fill", "white")
                .attr("r", circleR)
                .attr("cx", barX + (barW / 2))
                .attr("cy", (barHeight / 13) * i - textOffset - 5);

            let text = startDate.format('MMMM YYYY');
            if (startDate.month() != 0) {
                text = startDate.format('MMMM')
            }

            var year_text = svg.append("text")
                .attr("id", "d" + startDate.format('YYYYMM'))
                .attr("x", barX + barW + circleR + 10)
                .attr("y", (barHeight / 13) * i - textOffset)
                .attr("font-size", textSize)
                .attr("fill", "white")
                .text(text);


            var year_text = svg.append("text")
                .attr("id", "dt" + startDate.format('YYYYMM'))
                .attr("x", barX + barW + circleR + 10)
                .attr("y", (barHeight / 13) * i - textOffset + 20)
                .attr("font-size", 15)
                .attr("style", "white-space:pre-wrap")
                .attr("fill", "white")
                .text("1234567890123456789012345678901234567890 \ <br>jahjdga asasdasdasd dhja");
            svg.append("text")
                .attr("id", "dt2" + startDate.format('YYYYMM'))
                .attr("x", barX + barW + circleR + 10)
                .attr("y", (barHeight / 13) * i - textOffset + 20 + 15)
                .attr("font-size", 15)
                .attr("style", "white-space:pre-wrap")
                .attr("fill", "white")
                .text("asjksa;jkdkasjasd <br> \njhasddashjgsdahgdh \ <br>jahjdga asasdasdasd dhja")
                ;


            var test = svg.append("foreignObject")
                .attr("id", "dt" + startDate.format('YYYYMM'))
                .attr("x", barX + barW + circleR + 10)
                .attr("y", (barHeight / 13) * i - textOffset + 20)
                .attr("width", 150)
                .attr("height", 30)

            test.append("div")
                .attr("width", 150)
                .attr("height", 30)

                .attr("xmlns", "http://www.w3.org/1999/xhtml")
                .text("asjksa;jkdkasjasd asd assd das a");
            startDate.add(1, 'months');
        }



        // Render crosses ***********************

        var deaths = {
            "2013": {
                "dead": 636,
                "missing": 0,
                "total": 636
            },
            "2014": {
                "dead": 770,
                "missing": 2768,
                "total": 3538
            },
            "2015": {
                "dead": 1555,
                "missing": 2216,
                "total": 3771
            },
            "2016": {
                "dead": 1485,
                "missing": 3611,
                "total": 5096
            },
            "2017": {
                "dead": 795,
                "missing": 2344,
                "total": 3139
            },
            "2018": {
                "dead": 670,
                "missing": 1600,
                "total": 2270
            },
            "2019": {
                "dead": 272,
                "missing": 1063,
                "total": 1335
            },
            "2020": {
                "dead": 562,
                "missing": 839,
                "total": 1401
            },
            "2021": {
                "dead": 708,
                "missing": 937,
                "total": 1645
            }
        }

        var deathsHolder = document.getElementById("deathsHolder");


        /*
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-cross" width="64" height="64" viewBox="0 0 24 24" stroke-width="1.5" stroke="#000000" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M10 21h4v-9h5v-4h-5v-5h-4v5h-5v4h5z" />
        </svg>
        */

        const deathChartsvg = d3.select("#deathsChart")
            .attr("width", deathsHolder.clientWidth)
            .attr("height", deathsHolder.clientHeight)


        var xdeaths = 10;
        var ydeaths = 10;

        var deathSize = 400;

        document.getElementById('deathCountSize').innerHTML = deathSize.toString() + " people dead or missing on sea ";

        for (var year in deaths) {

            for (i = 0; i <= deaths[year].total; i += deathSize) {
                d3.select("#deathsChart")
                    .append('path')
                    .attr('d', "M10 21h4v-9h5v-4h-5v-5h-4v5h-5v4h5z")
                    .attr('class', 'death_' + year)
                    .attr("stroke", d => { return (parseInt(startDate.year) <= parseInt(year)) ? 'white' : 'transparent' })
                    .attr("fill", d => { return (parseInt(startDate.year) <= parseInt(year)) ? 'transparant' : 'transparent' })
                    .attr("transform", "translate(" + xdeaths + "," + ydeaths + ")")


                xdeaths += 20;
                if (xdeaths > deathsHolder.clientWidth / 2) {
                    xdeaths = 10
                    ydeaths += 25
                }
            }
        }
        // Render bar chart *********************

        var countriesChartParent = document.getElementById("countriesChartHolder");


        // append the svg object to the body of the page
        const countriesChartsvg = d3.select("#countriesChart")
            .attr("width", countriesChartParent.clientWidth)
            .attr("height", countriesChartParent.clientHeight)
            .append("g")
            .attr("transform", `translate(60,20)`);

        // Parse the Data

        var countriesData = {
            "2009": {
                "Other": 58116,
                "Unknown ": 46218,
                "Iraq": 21355,
                "Somalia": 18948,
                "Afghanistan": 16937,
                "Nigeria": 10638,
                "Pakistan": 8383,
                "Syrian Arab Rep.": 5331,
                "Eritrea": 3912
            },
            "2010": {
                "Other": 68461,
                "Afghanistan": 19520,
                "Iraq": 16594,
                "Unknown ": 15059,
                "Somalia": 14547,
                "Pakistan": 8254,
                "Nigeria": 7030,
                "Syrian Arab Rep.": 5610,
                "Eritrea": 3900
            },
            "2011": {
                "Other": 90741,
                "Unknown ": 49627,
                "Afghanistan": 28189,
                "Iraq": 15837,
                "Nigeria": 12867,
                "Pakistan": 12759,
                "Somalia": 12142,
                "Syrian Arab Rep.": 8105,
                "Eritrea": 5003
            },
            "2012": {
                "Other": 92453,
                "Afghanistan": 27528,
                "Syrian Arab Rep.": 23080,
                "Unknown ": 22106,
                "Pakistan": 16348,
                "Somalia": 14394,
                "Iraq": 12909,
                "Nigeria": 6882,
                "Eritrea": 6043
            },
            "2013": {
                "Other": 114697,
                "Syrian Arab Rep.": 50603,
                "Afghanistan": 26609,
                "Pakistan": 20168,
                "Somalia": 19775,
                "Eritrea": 13604,
                "Unknown ": 13264,
                "Iraq": 12108,
                "Nigeria": 11711
            },
            "2014": {
                "Other": 145841,
                "Syrian Arab Rep.": 121569,
                "Afghanistan": 41780,
                "Eritrea": 34299,
                "Pakistan": 22182,
                "Iraq": 21653,
                "Nigeria": 20164,
                "Somalia": 17770,
                "Unknown ": 9725
            },
            "2015": {
                "Syrian Arab Rep.": 366864,
                "Afghanistan": 178594,
                "Other": 175686,
                "Iraq": 122841,
                "Pakistan": 48127,
                "Eritrea": 31682,
                "Nigeria": 31068,
                "Unknown ": 24704,
                "Somalia": 21957
            },
            "2016": {
                "Syrian Arab Rep.": 344107,
                "Other": 234556,
                "Afghanistan": 190086,
                "Iraq": 130700,
                "Pakistan": 50156,
                "Nigeria": 47997,
                "Eritrea": 34380,
                "Unknown ": 22237,
                "Somalia": 22121
            },
            "2017": {
                "Other": 214190,
                "Syrian Arab Rep.": 108764,
                "Afghanistan": 63437,
                "Iraq": 55178,
                "Nigeria": 40946,
                "Pakistan": 35694,
                "Eritrea": 24550,
                "Somalia": 15364,
                "Unknown ": 10192
            },
            "2018": {
                "Other": 238311,
                "Syrian Arab Rep.": 102065,
                "Afghanistan": 68018,
                "Iraq": 60559,
                "Pakistan": 37738,
                "Nigeria": 37053,
                "Somalia": 19843,
                "Eritrea": 16950,
                "Unknown ": 13256
            },
            "2019": {
                "Other": 195296,
                "Syrian Arab Rep.": 76801,
                "Afghanistan": 59045,
                "Iraq": 33016,
                "Pakistan": 27799,
                "Nigeria": 24507,
                "Unknown ": 23061,
                "Somalia": 15395,
                "Eritrea": 9877
            },
            "2020": {
                "Other": 143155,
                "Syrian Arab Rep.": 72104,
                "Afghanistan": 52933,
                "Pakistan": 22878,
                "Iraq": 21629,
                "Nigeria": 17347,
                "Somalia": 12838,
                "Unknown ": 7909,
                "Eritrea": 7297
            }
        }



        // List of subgroups = header of the csv files = soil condition here
        //const subgroups = data.columns.slice(1)

        // Add X axis
        const x = d3.scaleBand()
            .domain(Object.keys(countriesData))
            .range([0, countriesChartParent.clientWidth - 100])
            .padding([0.2])

        countriesChartsvg
            .append("g")
            .attr("color", "white")
            .attr("transform", `translate(0, ${countriesChartParent.clientHeight - 40})`)
            .call(d3.axisBottom(x).tickSizeOuter(0));

        // Add Y axis
        const y = d3.scaleLinear()
            .domain([0, 1100000])
            .range([countriesChartParent.clientHeight - 40, 0]);
        countriesChartsvg.append("g").attr("color", "white")
            .call(d3.axisLeft(y));

        var color = d3.scaleOrdinal()
            .domain(Object.keys(countriesData["2009"]))
            .range(['#264653', '#2A9D8F', '#E9C46A', '#F4A261', '#E76F51', '#4daf4a', '#e41a1c', '#377eb8', '#B5E2FA'])

        var arr = [];

        for (var year in countriesData) {

            // only add allowed years meaning < selectedCurrent

            var temp = countriesData[year];
            temp['year'] = year;
            arr.push(temp);
        }

        //stack the data? --> stack per subgroup
        const stack = d3.stack()
            .keys(Object.keys(countriesData["2009"]))
            (arr)
        //.value((obj, key) => {console.log(obj); console.log(key); return obj[key] });

        // Show the bars
        countriesChartsvg.append("g")
            .selectAll("g")
            // Enter in the stack data = loop key per key = group per group
            .data(stack)
            .join("g")
            .attr("fill", function (d) { return color(d.key) })
            .selectAll("rect")
            // enter a second time = loop subgroup per subgroup to add all rectangles
            .data(d => d)
            .join("rect")
            .attr("class", d => { return "year" + d.data.year })
            .attr("x", d => { return x(d.data.year) })
            .attr("y", d => y(d[1]))
            .attr("height", d => { return (parseInt(currentDate.year()) >= parseInt(d.data.year)) ? (y(d[0]) - y(d[1])) : 0 })
            .attr("width", x.bandwidth())




        function updateDeathsperYear(monthChange) {
            var tempDate = moment(currentDate);

            if (monthChange < 0) {
                for (var i = 1; i <= monthChange * -1; i++) {
                    tempDate.add(1, 'month')

                    var elems = d3.selectAll(".death_" + tempDate.format("YYYY"));
                    elems.transition().attr("stroke", "transparent")
                }
            }

            for (var i = 1; i <= monthChange; i++) {
                tempDate.subtract(1, 'month')
                var elems = d3.selectAll(".death_" + tempDate.format("YYYY"));
                elems.transition().attr("stroke", "white")
            }
        }



        function updateCountriesPerYear(monthChange) {
            var tempDate = moment(currentDate);
            if (monthChange < 0) {
                for (var i = 1; i <= monthChange * -1; i++) {
                    tempDate.subtract(1, 'month')
                    // only add allowed years meaning < selectedCurrent
                    var elems = d3.selectAll(".year" + tempDate.format("YYYY"));

                    elems.transition().attr("height", 0)
                }

            }

            for (var i = 1; i <= monthChange; i++) {
                tempDate.subtract(1, 'month')

                // only add allowed years meaning < selectedCurrent
                var elems = d3.selectAll(".year" + tempDate.format("YYYY"));

                elems.transition().attr("height", d => { return y(d[0]) - y(d[1]) })
            }
        }

        function updateYearSlider(monthChange) {

            var oldDate = moment(currentDate);


            currentDate.add(monthChange, 'months');

            if (monthChange > 0) {
                oldDate.add(12, 'months');
                // going further in time
                // insert below svg
                for (var i = 1; i <= monthChange; i++) {
                    //
                    oldDate.add(1, 'months');

                    let text = oldDate.format('MMMM YYYY');
                    if (oldDate.month() != 0) {
                        text = oldDate.format('MMMM')
                    }
                    var year_text = svg.append("text")
                        .attr("id", "d" + oldDate.format('YYYYMM'))
                        .attr("x", barX + barW + circleR + 10)
                        .attr("y", (barHeight + (barHeight / 13) * i) - textOffset)
                        .attr("font-size", textSize)
                        .attr("fill", "white")
                        .attr("class", "activeDate")
                        .text(text);

                }
                // animate and mobve dates

                var startMovingDate = moment(currentDate);
                startMovingDate.subtract(monthChange, 'months');

                // Improve by select all?
                for (var i = 0; i <= monthChange + 12; i++) {


                    var elem = d3.select("#d" + startMovingDate.format('YYYYMM'));
                    elem
                        .attr("y", elem.attr("y") - (barHeight / 13) * monthChange)

                    //.duration(500)

                    if (startMovingDate.diff(currentDate, 'months') == 0) {
                        elem.attr("style", "font-weight:bold")
                    } else {
                        elem.attr("style", "")
                    }


                    startMovingDate.add(1, 'months');



                }

                var outrangeDate = moment(currentDate);
                //outrangeDate.subtract(12, 'months');

                // remove old below svg
                for (var i = 0; i < monthChange; i++) {
                    outrangeDate.subtract(1, 'months');
                    d3.select("#d" + outrangeDate.format('YYYYMM')).remove();
                }
            }

            if (monthChange < 0) {

                // going further in time
                // insert below svg
                for (var i = 0; i < monthChange * -1; i++) {
                    oldDate.subtract(1, 'months');

                    let text = oldDate.format('MMMM YYYY');
                    if (oldDate.month() != 0) {
                        text = oldDate.format('MMMM')
                    }
                    var year_text = svg.append("text")
                        .attr("id", "d" + oldDate.format('YYYYMM'))
                        .attr("x", barX + barW + circleR + 10)
                        .attr("y", (-1 * (barHeight / 13) * i) - textOffset)
                        .attr("font-size", textSize)
                        .attr("fill", "white")
                        .attr("class", "activeDate")
                        .text(text);
                }
                // animate and mobve dates

                var startMovingDate = moment(currentDate);
                //startMovingDate.add(monthChange,"month");

                // Improve by select all?
                for (var i = 0; i <= monthChange * -1 + 12; i++) {
                    var elem = d3.select("#d" + startMovingDate.format('YYYYMM'));
                    elem
                        .attr("y", elem.attr("y") - (barHeight / 13) * monthChange)

                    if (startMovingDate.diff(currentDate, 'months') == 0) {
                        elem.attr("style", "font-weight:bold")
                    } else {
                        elem.attr("style", "")
                    }
                    startMovingDate.add(1, 'months');
                }

                var outrangeDate = moment(currentDate);
                outrangeDate.add(12, 'months');

                // remove old below svg
                //wait 200 sec 
                for (var i = 0; i < monthChange * -1; i++) {
                    outrangeDate.add(1, 'months');
                    d3.select("#d" + outrangeDate.format('YYYYMM')).remove();
                }

            }
        }


        function handleScroll(event) {

            // Scrolling 
            // Down: + 
            // Up: - 
            var increasedMonth = Math.round(event.deltaY / 80);

            //update Year slider 
            if (increasedMonth != 0) {
                updateYearSlider(increasedMonth);
                updateCountriesPerYear(increasedMonth);
                updateDeathsperYear(increasedMonth)
            }
        }


        /******** RENDER MAP ****/



        var yearSliderParent = document.getElementById("mapHolder");
        let svg1 = d3.select("#main")
            .attr("width", yearSliderParent.clientWidth)
            .attr("height", yearSliderParent.clientHeight)

        // create arrow structure for animation
        svg1.append("defs")
            .append("symbol")
            .attr("id", "arrowheadsymbol")
            .attr("viewbox", "0 0 50 50")
            .attr("refX", "10")
            .attr("refY", "10")
            .attr("preserveAspectRatio", "xMidYMid")
            .attr("x", "0")
            .attr("y", "-15")
            .append("polygon")
            .attr("id", "arrowhead")
            .attr("points", "23.4,18.8 30,15 23.4,11.2 16.7,7.3 16.7,13 0,13 0,17 16.7,17 16.7,22.7")


        // A projection tells D3 how to orient the GeoJSON features
        let europeProjection = d3.geoMercator()
            .center([13, 52])
            .scale([yearSliderParent.clientWidth / 3.5])
            .translate([yearSliderParent.clientWidth / 1.5, yearSliderParent.clientHeight / 2])

        // The path generator uses the projection to convert the GeoJSON
        // geometry to a set of coordinates that D3 can understand
        let pathGenerator = d3.geoPath().projection(europeProjection)

        // data paths
        let geoJsonUrl_worldmap = "https://raw.githubusercontent.com/quintene/data_vis_data/main/map_geo_data.json"
        let geoJsonUrl_migrantroutes = "migration_routes(2).geojson"
        let path_IBCs_data = "https://raw.githubusercontent.com/quintene/data_vis_data/main/monthly_detections_of_IBCs.json"
        let path_route_mapping = "route_mapping.json"

        // variables for animation
        var start;
        let data_IBCs;
        const trajectories = [],
            arrowgroups = [],
            totalLengths = [],
            groups = [],
            scalingfactors = {}


        var oldDate = moment(currentDate);
        var in_animation = false;
        var in_animation_index = {};

        // Load world map
        d3.json(geoJsonUrl_worldmap).then(geojson => {
            // Tell D3 to render a path for each GeoJSON feature
            svg1.selectAll("path")
                .data(geojson.features)
                .enter()
                .append("path")
                .attr("xlink:href", "#border")
                .attr("class", "country")
                .attr("d", pathGenerator) // This is where the magic happens
                .attr("stroke", "white") // Color of the lines themselves
                .attr("fill", "black") // Color uses to fill in the lines
                .attr("id", function (d) { return d.properties.name; })
                .append("svg:title").text(function (d) { return d.properties.name; })

            // Load migrant routes and initialize all trajectories
            d3.json(geoJsonUrl_migrantroutes).then(geojson => {


                // Tell D3 to render a path for each GeoJSON feature
                svg1.selectAll("#main")
                    .data(geojson.features)
                    .enter()
                    .append("path")
                    .attr("href", "#migratoryroute")
                    .attr("class", "migratoryroute")
                    .attr("d", pathGenerator)
                    .attr("route_name", function (d) { return d.properties.route_name; })
                    .attr("route_index", function (d) { return d.properties.route_index; })
                    .attr("id", function (d) { return d.properties.route_name + "_" + d.properties.route_index; })

                // create all trajectories
                createTrajectory("Black_Sea", "0")
                // createTrajectory("Central_African_Routes", "0") DOESN'T EXIST ANYMORE
                // createTrajectory("Central_African_Routes", "1") DOESN'T EXIST ANYMORE
                createTrajectory("Central_African_Routes", "2")
                // createTrajectory("Central_African_Routes", "3") DOESN'T EXIST ANYMORE
                createTrajectory("Central_African_Routes", "4")
                createTrajectory("Central_African_Routes", "5")
                createTrajectory("Central_African_Routes", "6")
                createTrajectory("Central_African_Routes", "7")
                createTrajectory("Central_African_Routes", "8")
                createTrajectory("Central_African_Routes", "9")
                createTrajectory("Central_African_Routes", "10")
                // createTrajectory("Central_African_Routes", "11") DOESN'T EXIST ANYMORE
                createTrajectory("Syria_Africa", "0")
                createTrajectory("West_African", "0")
                createTrajectory("West_African", "1")
                createTrajectory("Syria_Africa", "1")
                createTrajectory("Spain", "0")
                createTrajectory("Spain", "1")
                createTrajectory("Tuni_Medi", "0")
                createTrajectory("ME_Africa", "0")
                createTrajectory("East_Africa", "0")
                createTrajectory("East_Africa", "1")
                createTrajectory("Turkey", "0")
                createTrajectory("Turkey", "1")
                createTrajectory("Egypt_Medi", "0")
                createTrajectory("Egypt_Medi", "1")
                createTrajectory("East_Asia", "0")
                createTrajectory("East_Asia", "1")
                createTrajectory("Russia", "0")
                createTrajectory("Easter_Europe", "0")
                createTrajectory("Norway", "0")
                createTrajectory("Norway", "1")
                createTrajectory("Greece_Italy", "0")
                createTrajectory("Libya_Medi", "0")
                createTrajectory("Turkey_Medi", "0")
                createTrajectory("Italy", "0")


                // read IBC (Illegal Border Crossing) and route_mapping sdata
                readTextFile(path_IBCs_data, function (text) {
                    data_IBCs = JSON.parse(text)
                    console.log(path_IBCs_data + ": completed JSON parsing...")
                    readTextFile(path_route_mapping, function (text) {
                        data_route_mapping = JSON.parse(text)
                        console.log((path_route_mapping + ": completed JSON parsing..."))
                        // START ANIMATION
                        requestAnimationFrame(update);
                    })
                })
            })
        })

        // function that creates <use> elements for arrows
        function addArrows(data, ref) {
            return d3.select("#main").append("g").attr("class", "arrowelement").selectAll("use")
                .data(data).enter()
                .append("use")
                .attr("href", "#arrowheadsymbol")
                .attr("route_name", ref)
                .attr("class", ref)
        }

        // function that builds trajectories and related variables
        function createTrajectory(route_name, route_index) {
            // routes with index -> route_id = route_name + "_" + route_index
            route_id = "#" + route_name + "_" + route_index
            trajectories.push(document.querySelector(route_id))
            totalLengths.push(trajectories.last().getTotalLength())
            groups.push(totalLengths.last() / 3)
            arrowgroups.push(addArrows(d3.range(3).map(function (d) { return d * groups.last() + 50; }), route_name))
        }


        function update_route(arrowheads_x, trajectory_x, group_x, totalLength_x, start, t, scalingfactor, index) {
            var offset = -group_x * ((t - start) % 900) / 900;

            if (in_animation_index[index] == true) {
                return
            }

            if (currentDate.format("YYYY") != oldDate.format("YYYY")) {
                in_animation_index[index] = true;
                arrowheads_x
                    .transition()
                    .duration(500)
                    .attr("transform", function (d) {
                        var l = d - offset;

                        if (l < 0) {
                            l = totalLength_x + l;
                        } else if (l > totalLength_x) {
                            l -= totalLength_x;
                        }

                        var p = pointAtLength(l, trajectory_x, scalingfactor);
                        return "translate(" + p + ") rotate( " + angleAtLength(l, trajectory_x, scalingfactor) + ") scale(" + scalingfactor + ")";
                    })
                    .on("end", () => {
                        in_animation_index[index] = false

                        in_animation = false;

                        var change_date = true;
                        for (i in in_animation_index) {
                            if (in_animation_index == true) {
                                change_date = false;
                            }
                        }

                        if (change_date) {
                            oldDate = moment(currentDate);
                        }

                    });




            } else {



                arrowheads_x
                    .attr("transform", function (d) {

                        var l = d - offset;

                        if (l < 0) {
                            l = totalLength_x + l;
                        } else if (l > totalLength_x) {
                            l -= totalLength_x;
                        }

                        var p = pointAtLength(l, trajectory_x, scalingfactor);
                        return "translate(" + p + ") rotate( " + angleAtLength(l, trajectory_x, scalingfactor) + ") scale(" + scalingfactor + ")";
                    });
            }
        }

        function resetAnimation(index) {
            in_animation_index[index] = false

            in_animation = false;

            var change_date = true;
            for (i in in_animation_index) {
                if (in_animation_index == true) {
                    change_date = false;
                }
            }

            if (change_date) {
                oldDate = moment(currentDate);
            }

        }

        function readTextFile(file, callback) {
            var rawFile = new XMLHttpRequest();
            rawFile.overrideMimeType("application/json");
            rawFile.open("GET", file, true);
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4 && rawFile.status == "200") {
                    callback(rawFile.responseText);
                }
            }
            rawFile.send(null);
            // //usage:
            // readTextFile("/Users/Documents/workspace/test.json", function (text) {
            //     var data = JSON.parse(text);
            //     console.log(data);
            // });
        }


        function fetch_scalingfactor(year, trajectory_x) {
            // calculate the scale size of the arrows, corresponding to the amount of IBCs (illegal border crossings) 
            // for a given route and a given year for all origin countries combined. Saves the scalingfactor for later saving.
            if (Object.keys(scalingfactors).includes(year)) {
                if (Object.keys(scalingfactors[year]).includes(trajectory_x.getAttribute("id"))) {
                    return scalingfactors[year][trajectory_x.getAttribute("id")]
                }
            } else {
                scalingfactors[year] = {}
            }

            var sum_IBCs = 0
            var scalingfactor;
            // Using the following formula to dampen the variation in scaling factors m = ( ( n - 1 ) / d ) + 1 
            var dampingfactor = 1.1;
            data_IBCs.Detections_of_IBC.forEach(element => {
                if (!Object.keys(data_route_mapping).includes(element.Route)) {
                    return;
                }
                if (Object.keys(data_route_mapping[element.Route]).includes(trajectory_x.getAttribute("route_name"))) {
                    // Factor to correct for trajectories that contribute less to actual migration Route (e.g. Turkey_Medi to Central Mediterrenean Route) 
                    correctionfactor = data_route_mapping[element.Route][trajectory_x.getAttribute("route_name")]
                    sum_IBCs += sum_monthly_IBCs(element, year) * correctionfactor
                }
            })
            console.log("sum_IBCs route " + trajectory_x.getAttribute("route_name") + " = " + sum_IBCs);
            if (sum_IBCs == 0) {
                return scalingfactors[year][trajectory_x.getAttribute("id")] = 0
            } else {
                // return scalingfactors[year][trajectory_x.getAttribute("id")] = Math.log(sum_IBCs)/Math.log(2) / dampingfactor
                // return scalingfactors[year][trajectory_x.getAttribute("id")] = ((sum_IBCs / 1500000 - 3) / dampingfactor) + 3
                scalefactor = 200000
                return scalingfactors[year][trajectory_x.getAttribute("id")] = ((sum_IBCs / scalefactor > 1.75) ? 1.75 : ((sum_IBCs / scalefactor < 0.1) ? 0.1 : sum_IBCs / scalefactor))
            }
        }

        function sum_monthly_IBCs(country_IBCs, year) {
            // Calculate combined yearly IBCs for a single country. 
            var sum_IBCs_country = 0;
            Object.keys(country_IBCs).forEach(element => {
                if (element.includes(year)) {
                    sum_IBCs_country += parseInt(country_IBCs[element])
                }
            })
            return sum_IBCs_country;
        }

        function update(t) {
            if (!start) {
                start = t;
            }
            // update_route function to update trajectories
            trajectories.forEach(updatefunction);
            function updatefunction(value, index, array) {
                scalingfactor = fetch_scalingfactor(currentDate.format("YYYY"), trajectories[index])
                update_route(arrowgroups[index], trajectories[index], groups[index], totalLengths[index], start, t, scalingfactor, index)
            }


            requestAnimationFrame(update);
        }

        function pointAtLength(l, trajectory_x, scalingfactor) {

            var xy = trajectory_x.getPointAtLength(l);
            return [xy.x - scalingfactor * 0, xy.y - scalingfactor * 0];

        }

        // Approximate tangent
        function angleAtLength(l, trajectory_x, scalingfactor) {

            var a = pointAtLength(Math.max(l - 0.01, 0), trajectory_x, scalingfactor), // this could be slightly negative
                b = pointAtLength(l + 0.01, trajectory_x, scalingfactor); // browsers cap at total length

            return Math.atan2(b[1] - a[1], b[0] - a[0]) * 180 / Math.PI;

        }
        // last() function
        if (!Array.prototype.last) {
            Array.prototype.last = function () {
                return this[this.length - 1];
            };
        };




    </script>

</body>

</html>